generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships  Membership[]
  locations    Location[]
  policies     PolicyConfig[]
  invites      Invite[]

  @@index([slug])
}

model Membership {
  id     String         @id @default(cuid())
  userId String
  orgId  String
  org    Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role   MembershipRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, orgId])
  @@index([userId])
  @@index([orgId])
}

model Invite {
  id        String   @id @default(cuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  email     String?
  code      String   @unique
  role      MembershipRole @default(MEMBER)
  usedBy    String?
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([code])
  @@index([orgId])
}

model Location {
  id             String           @id @default(cuid())
  name           String
  code           String?
  category       LocationCategory
  address        String?
  latitude       Float
  longitude      Float
  geofenceRadius Int              @default(200)
  isDefault      Boolean          @default(false)

  // Shared locations: orgId set, userId null
  // Personal locations (WFH): orgId set, userId set
  orgId  String?
  org    Organization? @relation(fields: [orgId], references: [id])
  userId String?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  entries  Entry[]
  workDays WorkDay[]
  callouts Callout[]

  @@index([userId])
  @@index([orgId])
}

model Entry {
  id              String    @id @default(cuid())
  type            EntryType
  timestampClient DateTime
  timestampServer DateTime  @default(now())

  userId String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  gpsLatitude  Float?
  gpsLongitude Float?
  gpsAccuracy  Float?

  photoUrl String?
  notes    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  editHistory Json?

  workDayId String?
  workDay   WorkDay? @relation(fields: [workDayId], references: [id])

  @@index([userId])
  @@index([locationId])
  @@index([timestampServer])
}

model WorkDay {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  userId String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  firstClockIn DateTime?
  lastClockOut DateTime?
  totalMinutes Int?

  meetsPolicy Boolean @default(false)

  entries Entry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, locationId, userId])
  @@index([userId])
  @@index([date])
}

model PolicyConfig {
  id                   String   @id @default(cuid())
  name                 String
  requiredDaysPerWeek  Int      @default(3)
  minimumMinutesPerDay Int      @default(0)
  effectiveDate        DateTime @default(now())
  isActive             Boolean  @default(true)

  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model AppConfig {
  id        String   @id @default("singleton")
  pinHash   String?
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Callout {
  id             String   @id @default(cuid())
  incidentNumber String

  userId String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  timeReceived   DateTime
  timeStarted    DateTime?
  timeEnded      DateTime?

  gpsLatitude    Float?
  gpsLongitude   Float?
  gpsAccuracy    Float?

  description    String?
  resolution     String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([userId, timeReceived])
}

model LeaveRequest {
  id       String    @id @default(cuid())
  userId   String
  type     LeaveType
  date     DateTime  @db.Date
  endDate  DateTime? @db.Date
  notes    String?
  status   LeaveStatus @default(APPROVED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

enum MembershipRole {
  ADMIN
  MEMBER
}

enum LeaveType {
  PTO
  SICK
  HOLIDAY
  PERSONAL
  BEREAVEMENT
  JURY_DUTY
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  DENIED
}

enum LocationCategory {
  OFFICE
  PLANT
  CUSTOMER
  HOME
  TRAVEL
  OTHER
}

enum EntryType {
  CLOCK_IN
  CLOCK_OUT
}
