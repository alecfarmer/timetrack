generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Location {
  id             String           @id @default(cuid())
  name           String           // "Michelin Donaldson"
  code           String?          // "US0"
  category       LocationCategory
  address        String?
  latitude       Float
  longitude      Float
  geofenceRadius Int              @default(200) // meters
  isDefault      Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  entries  Entry[]
  workDays WorkDay[]
}

model Entry {
  id              String    @id @default(cuid())
  type            EntryType
  timestampClient DateTime  // What the user's device reported
  timestampServer DateTime  @default(now()) // Authoritative server time

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  gpsLatitude  Float?
  gpsLongitude Float?
  gpsAccuracy  Float? // meters

  photoUrl String?
  notes    String?

  // Immutable audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  editHistory Json? // Array of previous values if edited

  workDayId String?
  workDay   WorkDay? @relation(fields: [workDayId], references: [id])
}

model WorkDay {
  id   String   @id @default(cuid())
  date DateTime @db.Date // Just the date, no time

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  firstClockIn DateTime?
  lastClockOut DateTime?
  totalMinutes Int?

  meetsPolicy Boolean @default(false)

  entries Entry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, locationId])
}

model PolicyConfig {
  id                   String   @id @default(cuid())
  name                 String   // "Standard 3-Day Policy"
  requiredDaysPerWeek  Int      @default(3)
  minimumMinutesPerDay Int      @default(0) // Optional: must be on-site X minutes to count
  effectiveDate        DateTime @default(now())
  isActive             Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AppConfig {
  id        String   @id @default("singleton")
  pinHash   String?  // bcrypt hashed 6-digit PIN
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LocationCategory {
  OFFICE
  PLANT
  CUSTOMER
  HOME
  TRAVEL
  OTHER
}

enum EntryType {
  CLOCK_IN
  CLOCK_OUT
}
