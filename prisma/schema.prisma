generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdBy String
  features  Json     @default("{\"photoVerification\":false,\"breakTracking\":false,\"timesheetApproval\":false,\"alerts\":true,\"analytics\":true,\"manualCorrections\":true,\"auditLog\":true}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships  Membership[]
  locations    Location[]
  policies     PolicyConfig[]
  invites      Invite[]
  auditLogs    AuditLog[]
  alertRules   AlertRule[]
  alertNotifications AlertNotification[]
  timesheets   TimesheetSubmission[]

  @@index([slug])
}

model Membership {
  id     String         @id @default(cuid())
  userId String
  orgId  String
  org    Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role   MembershipRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, orgId])
  @@index([userId])
  @@index([orgId])
}

model Invite {
  id        String   @id @default(cuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  email     String?
  code      String   @unique
  role      MembershipRole @default(MEMBER)
  usedBy    String?
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([code])
  @@index([orgId])
}

model Location {
  id             String           @id @default(cuid())
  name           String
  code           String?
  category       LocationCategory
  address        String?
  latitude       Float
  longitude      Float
  geofenceRadius Int              @default(200)
  isDefault      Boolean          @default(false)

  // Shared locations: orgId set, userId null
  // Personal locations (WFH): orgId set, userId set
  orgId  String?
  org    Organization? @relation(fields: [orgId], references: [id])
  userId String?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  entries  Entry[]
  workDays WorkDay[]
  callouts Callout[]

  @@index([userId])
  @@index([orgId])
}

model Entry {
  id              String    @id @default(cuid())
  type            EntryType
  timestampClient DateTime
  timestampServer DateTime  @default(now())

  userId String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  gpsLatitude  Float?
  gpsLongitude Float?
  gpsAccuracy  Float?

  photoUrl String?
  notes    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  editHistory Json?
  corrections EntryCorrection[]

  workDayId String?
  workDay   WorkDay? @relation(fields: [workDayId], references: [id])

  @@index([userId])
  @@index([locationId])
  @@index([timestampServer])
}

model WorkDay {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  userId String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  firstClockIn DateTime?
  lastClockOut DateTime?
  totalMinutes Int?

  breakMinutes Int     @default(0)
  meetsPolicy  Boolean @default(false)

  entries Entry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, locationId, userId])
  @@index([userId])
  @@index([date])
}

model PolicyConfig {
  id                   String   @id @default(cuid())
  name                 String
  requiredDaysPerWeek  Int      @default(3)
  minimumMinutesPerDay Int      @default(0)
  breakMinutesPerDay   Int      @default(0)
  autoDeductBreak      Boolean  @default(false)
  effectiveDate        DateTime @default(now())
  isActive             Boolean  @default(true)

  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model AppConfig {
  id        String   @id @default("singleton")
  pinHash   String?
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Callout {
  id             String   @id @default(cuid())
  incidentNumber String

  userId String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  timeReceived   DateTime
  timeStarted    DateTime?
  timeEnded      DateTime?

  gpsLatitude    Float?
  gpsLongitude   Float?
  gpsAccuracy    Float?

  description    String?
  resolution     String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([userId, timeReceived])
}

model LeaveRequest {
  id       String    @id @default(cuid())
  userId   String
  type     LeaveType
  date     DateTime  @db.Date
  endDate  DateTime? @db.Date
  notes    String?
  status   LeaveStatus @default(APPROVED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

enum MembershipRole {
  ADMIN
  MEMBER
}

enum LeaveType {
  PTO
  SICK
  HOLIDAY
  PERSONAL
  BEREAVEMENT
  JURY_DUTY
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  DENIED
}

enum LocationCategory {
  OFFICE
  PLANT
  CUSTOMER
  HOME
  TRAVEL
  OTHER
}

model AuditLog {
  id         String   @id @default(cuid())
  orgId      String
  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String
  action     String
  entityType String
  entityId   String?
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([action])
}

model EntryCorrection {
  id           String   @id @default(cuid())
  entryId      String
  entry        Entry    @relation(fields: [entryId], references: [id], onDelete: Cascade)
  correctedBy  String
  reason       String
  fieldChanged String
  oldValue     String?
  newValue     String?
  createdAt    DateTime @default(now())

  @@index([entryId])
}

model TimesheetSubmission {
  id           String   @id @default(cuid())
  userId       String
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  weekStart    DateTime @db.Date
  weekEnd      DateTime @db.Date
  status       String   @default("PENDING")
  totalMinutes Int      @default(0)
  totalDays    Int      @default(0)
  submittedAt  DateTime @default(now())
  reviewedBy   String?
  reviewedAt   DateTime?
  reviewNotes  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, weekStart])
  @@index([orgId])
  @@index([status])
}

model AlertRule {
  id        String   @id @default(cuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  type      String
  config    Json     @default("{}")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notifications AlertNotification[]

  @@index([orgId])
}

model AlertNotification {
  id           String   @id @default(cuid())
  orgId        String
  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  ruleId       String?
  rule         AlertRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  targetUserId String
  type         String
  title        String
  message      String
  isRead       Boolean  @default(false)
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([targetUserId])
  @@index([targetUserId, isRead])
  @@index([createdAt(sort: Desc)])
}

enum EntryType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
}
